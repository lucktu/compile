name: Build n2n Binaries  
  
on:  
  push:  
    branches: [ main, master ]  
    tags:  
      - 'v*'  
  pull_request:  
    branches: [ main, master ]  
  workflow_dispatch:  
  
jobs:  
  build-linux:  
    name: Build for Linux (${{ matrix.arch }})  
    runs-on: ubuntu-latest  
    strategy:  
      matrix:  
        arch: [x86_64, aarch64, armv7, mipsel]  
      
    steps:  
      - name: Checkout code  
        uses: actions/checkout@v3  
        with:  
          fetch-depth: 0  
        
      - name: Install dependencies  
        run: |  
          sudo apt-get update  
          sudo apt-get install -y build-essential autoconf automake libtool \  
            libssl-dev zlib1g-dev libcap-dev libpcap-dev  
        
      - name: Setup cross-compilation (non-x86_64)  
        if: matrix.arch != 'x86_64'  
        run: |  
          if [ "${{ matrix.arch }}" = "aarch64" ]; then  
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu  
            echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV  
            echo "AR=aarch64-linux-gnu-ar" >> $GITHUB_ENV  
            echo "HOST_TRIPLET=aarch64-linux-gnu" >> $GITHUB_ENV  
          elif [ "${{ matrix.arch }}" = "armv7" ]; then  
            sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf  
            echo "CC=arm-linux-gnueabihf-gcc" >> $GITHUB_ENV  
            echo "AR=arm-linux-gnueabihf-ar" >> $GITHUB_ENV  
            echo "HOST_TRIPLET=arm-linux-gnueabihf" >> $GITHUB_ENV  
          elif [ "${{ matrix.arch }}" = "mipsel" ]; then  
            sudo apt-get install -y gcc-mipsel-linux-gnu g++-mipsel-linux-gnu  
            echo "CC=mipsel-linux-gnu-gcc" >> $GITHUB_ENV  
            echo "AR=mipsel-linux-gnu-ar" >> $GITHUB_ENV  
            echo "HOST_TRIPLET=mipsel-linux-gnu" >> $GITHUB_ENV  
          fi  
        
      - name: Build with autotools  
        run: |  
          ./autogen.sh  
          if [ -n "$HOST_TRIPLET" ]; then  
            ./configure --host=$HOST_TRIPLET CFLAGS="-O2 -static"  
          else  
            ./configure CFLAGS="-O2 -static"  
          fi  
          make  
        
      - name: Package binaries  
        run: |  
          mkdir -p release  
          cp edge release/edge-linux-${{ matrix.arch }}  
          cp supernode release/supernode-linux-${{ matrix.arch }}  
          strip release/*  
        
      - name: Upload artifacts  
        uses: actions/upload-artifact@v3  
        with:  
          name: n2n-linux-${{ matrix.arch }}  
          path: release/*  
  
  build-macos:  
    name: Build for macOS  
    runs-on: macos-latest  
      
    steps:  
      - name: Checkout code  
        uses: actions/checkout@v3  
        with:  
          fetch-depth: 0  
        
      - name: Install dependencies  
        run: |  
          brew install autoconf automake libtool openssl@1.1 zstd libpcap  
        
      - name: Build with autotools  
        run: |  
          ./autogen.sh  
          ./configure CFLAGS="-I/usr/local/opt/openssl@1.1/include -O2" \  
                      LDFLAGS="-L/usr/local/opt/openssl@1.1/lib/"  
          make  
        
      - name: Package binaries  
        run: |  
          mkdir -p release  
          cp edge release/edge-macos-x86_64  
          cp supernode release/supernode-macos-x86_64  
          strip release/*  
        
      - name: Upload artifacts  
        uses: actions/upload-artifact@v3  
        with:  
          name: n2n-macos-x86_64  
          path: release/*  
  
  build-windows:  
    name: Build for Windows  
    runs-on: windows-latest  
      
    steps:  
      - name: Checkout code  
        uses: actions/checkout@v3  
        with:  
          fetch-depth: 0  
        
      - name: Setup MSBuild  
        uses: microsoft/setup-msbuild@v1  
        
      - name: Install OpenSSL  
        run: |  
          choco install openssl -y  
        
      - name: Build with CMake  
        run: |  
          mkdir build  
          cd build  
          cmake -G "Visual Studio 17 2022" -A x64 ..  
          cmake --build . --config Release  
        
      - name: Package binaries  
        run: |  
          mkdir release  
          copy build\Release\edge.exe release\edge-windows-x86_64.exe  
          copy build\Release\supernode.exe release\supernode-windows-x86_64.exe  
        
      - name: Upload artifacts  
        uses: actions/upload-artifact@v3  
        with:  
          name: n2n-windows-x86_64  
          path: release/*  
  
  create-release:  
    name: Create Release  
    needs: [build-linux, build-macos, build-windows]  
    runs-on: ubuntu-latest  
    if: startsWith(github.ref, 'refs/tags/v')  
      
    steps:  
      - name: Download all artifacts  
        uses: actions/download-artifact@v3  
        with:  
          path: artifacts  
        
      - name: Create Release  
        uses: softprops/action-gh-release@v1  
        with:  
          files: artifacts/**/*  
          draft: false  
          prerelease: false  
        env:  
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
