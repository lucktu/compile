name: Build n2n Binaries

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout lucktu/cnn2n source code
        uses: actions/checkout@v4
        with:
          repository: lucktu/cnn2n
          path: source

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libssl-dev zlib1g-dev

      - name: Build with CMake
        run: |
          cd source
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make edge supernode

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: |
            source/build/edge
            source/build/supernode

  build-windows:
    name: Build for Windows
    runs-on: windows-latest

    steps:
      - name: Checkout lucktu/cnn2n source code
        uses: actions/checkout@v4
        with:
          repository: lucktu/cnn2n
          path: source

      - name: Install dependencies
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          choco install openssl

      - name: Fix CMake version requirement
        working-directory: source
        run: |
          (Get-Content CMakeLists.txt) -replace 'cmake_minimum_required\(VERSION 2\.6\)', 'cmake_minimum_required(VERSION 3.5)' | Set-Content CMakeLists.txt

      - name: Configure CMake
        working-directory: source
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_POLICY_VERSION_MINIMUM=3.5 ..

      - name: Build
        working-directory: source/build
        run: |
          cmake --build . --config Release

      - name: Upload Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            source/build/Release/edge.exe
            source/build/Release/supernode.exe

#  build-macos:
#    name: Build for macOS
#    runs-on: macos-latest
#
#    steps:
#      - name: Checkout lucktu/cnn2n source code
#        uses: actions/checkout@v4
#        with:
#          repository: lucktu/cnn2n
#          path: source
#
#      - name: Install dependencies
#        run: |
#          brew install openssl@1.1
#
#      - name: Configure CMake
#        working-directory: source
#        run: |
#          mkdir build
#          cd build
#          cmake -G "Unix Makefiles" \
#                -DCMAKE_BUILD_TYPE=Release \
#                -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl@1.1 \
#                ..
#
#      - name: Build
#        working-directory: source/build
#        run: make -j$(sysctl -n hw.ncpu)
#
#      - name: Upload macOS binaries
#        uses: actions/upload-artifact@v4
#        with:
#          name: macos-binaries
#          path: |
#            source/build/edge
#            source/build/supernode

  release:
    name: Create Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-binaries/*
            windows-binaries/*
            macos-binaries/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
